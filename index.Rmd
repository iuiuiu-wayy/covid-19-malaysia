---
title: "Covid-19 Situation in Malaysia"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: https://github.com/wnarifin/covid-19-malaysia/
---

```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(plotly)
library(broom)
library(data.world)

# covid_my = read.csv("https://wnarifin.github.io/covid-19-malaysia/covid-19_my_full.csv")
covid_my_full = read.csv("covid-19_my_full.csv")
covid_my_full$date = as.Date(covid_my_full$date)

sel_location = "Malaysia"
sel_date = max(covid_my_full$date) - 1  # display date, offset - 1

date_now = max(covid_my_full$date)
days_tabligh_now = max(covid_my_full$days_tabligh)
days_mco_now = max(covid_my_full$days_mco)

# cases
model1 = glm(new_cases ~ days_tabligh + days_mco, family = "quasipoisson",  data = covid_my_full)
summary(model1)
coef(model1)

data_week = data.frame(date = date_now + 1:7, new_cases = rep(NA, 7), total_cases = rep(NA, 7),
                       days_tabligh = days_tabligh_now + 1:7, days_mco = days_mco_now + 1:7)
data_plot = subset(covid_my_full, select = c(date, new_cases, total_cases, days_tabligh, days_mco))
data_plot = rbind(data_plot, data_week)
data_plot$new_cases_predicted = round(predict(model1, data_plot, type = "response"))
data_plot$total_cases_predicted = cumsum(data_plot$new_cases_predicted)

# based on growth in 7 days, get the slope
increase_day = (data_plot[data_plot$date == date_now + 7, "total_cases_predicted"] - data_plot[data_plot$date == date_now, "total_cases_predicted"]) / 7
rate = (data_plot[data_plot$date == date_now + 4, "total_cases_predicted"] + increase_day) / data_plot[data_plot$date == date_now + 4, "total_cases_predicted"]
days_to_double = log(2) / log(rate)

model1_rr = tidy(model1, conf.int = T, exponentiate = T)

# deaths
model2 = glm(new_deaths ~ total_cases + days_mco, family = "quasipoisson", data = covid_my_full); summary(model2)
# must include mco as the start of intervention
# total_cases to indicate the burden to healthcare
coef(model2)

# have to use total_cases_predicted as total_cases
data_week1 = data.frame(date = date_now + 1:7, total_cases = tail(data_plot$total_cases_predicted, 7),
                        new_deaths = rep(NA, 7), total_deaths = rep(NA, 7), days_mco = days_mco_now + 1:7)
data_plot1 = subset(covid_my_full, select = c(date, total_cases, new_deaths, total_deaths, days_mco))
data_plot1 = rbind(data_plot1, data_week1)
data_plot1$new_deaths_predicted = round(predict(model2, data_plot1, type = "response"))
data_plot1$total_deaths_predicted = cumsum(data_plot1$new_deaths_predicted)

model2_rr = tidy(model2, conf.int = T, exponentiate = T)
```

Overview
========

Row
---

### `r paste0("by ", format(sel_date, "%d %B %Y"), ", 12PM")` {.value-box}
```{r}
valueBox(
  value = "Covid-19 Statistics",
)
```

Row
---

### New cases {.value-box}
```{r}
valueBox(
  value = covid_my_full[dim(covid_my_full)[1], "new_cases"],
  icon = "fa-area-chart",
  color = "orange"
)
```

### Total cases {.value-box}
```{r}
valueBox(
  value = covid_my_full[dim(covid_my_full)[1], "total_cases"],
  icon = "fa-area-chart",
  color = "orange"
)
```

### cases per 100,000 persons {.value-box}
```{r}
# Malaysian population is 32.68 mil at 4th quarter 2019
valueBox(
  value = round(covid_my_full[dim(covid_my_full)[1], "total_cases"] / (32.68*1000000) * 100000, 2),
  icon = "fa-area-chart",
  color = "orange"
)
```

### days to double the number of total cases {.value-box}
```{r}
valueBox(
  value = round(days_to_double, 2),
  icon = "fa-area-chart",
  color = "orange"
)
```

Row
---

### New deaths {.value-box}
```{r}
valueBox(
  value = covid_my_full[dim(covid_my_full)[1], "new_deaths"],
  icon = "fa-area-chart",
  color = "red"
)
```

### Total deaths {.value-box}
```{r}
valueBox(
  value = covid_my_full[dim(covid_my_full)[1], "total_deaths"],
  icon = "fa-area-chart",
  color = "red"
)
```

### deaths per 1000 cases {.value-box}
```{r}
valueBox(
  value = round(covid_my_full[dim(covid_my_full)[1], "total_deaths"] / covid_my_full[dim(covid_my_full)[1], "total_cases"] * 1000, 2),
  icon = "fa-area-chart",
  color = "red"
)
```

Row
---

### in ICU {.value-box}
```{r}
valueBox(
  value = covid_my_full[dim(covid_my_full)[1], "icu"],
  icon = "fa-area-chart",
  color = "blue"
)
```

### require breathing Support {.value-box}
```{r}
valueBox(
  value = covid_my_full[dim(covid_my_full)[1], "support"],
  icon = "fa-area-chart",
  color = "blue"
)
```

Row
---

### Recovered {.value-box}
```{r}
valueBox(
  value = covid_my_full[dim(covid_my_full)[1], "recover"],
  icon = "fa-area-chart",
  color = "green"
)
```

### Total recovered {.value-box}
```{r}
valueBox(
  value = covid_my_full[dim(covid_my_full)[1], "total_recover"],
  icon = "fa-area-chart",
  color = "green"
)
```

### recovered per 1000 cases {.value-box}
```{r}
valueBox(
  value = round(covid_my_full[dim(covid_my_full)[1], "total_recover"] / covid_my_full[dim(covid_my_full)[1], "total_cases"] * 1000, 2),
  icon = "fa-area-chart",
  color = "green"
)
```

Row
---

### **Sources:** Director-General of Health Malaysia and Department of Statistics Malaysia. {.value-box}
```{r}
valueBox(
  value = "",
)
```

Cases
=====

Row
---

### new cases today  {.value-box}
```{r}
valueBox(
  value = data_plot[data_plot$date == date_now, "new_cases"],
  #icon = "fa-area-chart",
  color = "orange"
)
```

### new cases expected tomorrow  {.value-box}
```{r}
valueBox(
  value = data_plot[data_plot$date == date_now + 1, "new_cases_predicted"],
  #icon = "fa-area-chart",
  color = "orange"
)
```

### additional new cases expected in 3 days  {.value-box}
```{r}
valueBox(
  value = data_plot[data_plot$date == date_now + 3, "total_cases_predicted"] - data_plot[data_plot$date == date_now, "total_cases_predicted"],
  #icon = "fa-area-chart",
  color = "orange"
)
```

### additional new cases expected in a week  {.value-box}
```{r}
valueBox(
  value = data_plot[data_plot$date == date_now + 7, "total_cases_predicted"] - data_plot[data_plot$date == date_now, "total_cases_predicted"],
  #icon = "fa-area-chart",
  color = "orange"
)
```

### total cases today  {.value-box}
```{r}
valueBox(
  value = data_plot[data_plot$date == date_now, "total_cases_predicted"],
  #icon = "fa-area-chart",
  color = "orange"
)
```

### total cases expected in a week  {.value-box}
```{r}
valueBox(
  value = data_plot[data_plot$date == date_now + 7, "total_cases_predicted"],
  #icon = "fa-area-chart",
  color = "orange"
)
```

Row
---

### `r paste0("New cases by ", format(sel_date, "%d %B %Y"))`
```{r}
# daily
plot1 = ggplot(data_plot) +
  geom_col(aes(x = date, y = new_cases), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = new_cases_predicted), color = "blue", alpha = 0.7) +
  labs(x = "Date", y = "New cases") +
  theme_light()
plot1
ggplotly(plot1)
```

### `r paste0("Total cases by ", format(sel_date, "%d %B %Y"))`
```{r}
# cumulative
plot2 = ggplot(data_plot) +
  geom_col(aes(x = date, y = total_cases), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = total_cases_predicted), color = "blue", alpha = 0.7) +
  labs(x = "Date", y = "Cumulative cases") +
  theme_light()
plot2
ggplotly(plot2)
```

Row
---

### **Significant factors:** 1. Days since Tabligh gathering (`r paste0("Rate ratio: ", round(model1_rr[2, "estimate"],2), " [95% CI: ", round(model1_rr[2, "conf.low"],2), ", ", round(model1_rr[2, "conf.high"],2), "]")` per day), 2. Days since movement control order (`r paste0("Rate ratio: ", round(model1_rr[3, "estimate"],2), " [95% CI: ", round(model1_rr[3, "conf.low"],2), ", ", round(model1_rr[3, "conf.high"],2), "]")` per day) based on a quasipoisson regression model. {.value-box}
```{r}
valueBox(
  value = "",
)
```

Deaths
======

Row
---

### new deaths today  {.value-box}
```{r}
valueBox(
  value = data_plot1[data_plot1$date == date_now, "new_deaths"],
  #icon = "fa-area-chart",
  color = "red"
)
```

### new deaths expected tomorrow  {.value-box}
```{r}
valueBox(
  value = data_plot1[data_plot1$date == date_now + 1, "new_deaths_predicted"],
  #icon = "fa-area-chart",
  color = "red"
)
```

### additional new deaths expected in 3 days  {.value-box}
```{r}
valueBox(
  value = data_plot1[data_plot1$date == date_now + 3, "total_deaths_predicted"] - data_plot1[data_plot1$date == date_now, "total_deaths_predicted"],
  #icon = "fa-area-chart",
  color = "red"
)
```

### additional new deaths expected in a week  {.value-box}
```{r}
valueBox(
  value = data_plot1[data_plot1$date == date_now + 7, "total_deaths_predicted"] - data_plot1[data_plot1$date == date_now, "total_deaths_predicted"],
  #icon = "fa-area-chart",
  color = "red"
)
```

### total deaths today  {.value-box}
```{r}
valueBox(
  value = data_plot1[data_plot1$date == date_now, "total_deaths_predicted"],
  #icon = "fa-area-chart",
  color = "red"
)
```

### total deaths expected in a week  {.value-box}
```{r}
valueBox(
  value = data_plot1[data_plot1$date == date_now + 7, "total_deaths_predicted"],
  #icon = "fa-area-chart",
  color = "red"
)
```

Row
---

### `r paste0("New deaths by ", format(sel_date, "%d %B %Y"))`
```{r}
# daily
plot3 = ggplot(data_plot1) +
  geom_col(aes(x = date, y = new_deaths), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = new_deaths_predicted), color = "blue", alpha = 0.7) +
  labs(x = "Date", y = "New deaths", title = paste0("New deaths by ", format(sel_date, "%d %B %Y"))) +
  theme_light()
plot3
ggplotly(plot3)
```

### `r paste0("Total deaths by ", format(sel_date, "%d %B %Y"))`
```{r}
# cumulative
plot4 = ggplot(data_plot1) +
  geom_col(aes(x = date, y = total_deaths), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = total_deaths_predicted), color = "blue", alpha = 0.7) +
  labs(x = "Date", y = "Cumulative deaths", title = paste0("Total deaths by ", format(sel_date, "%d %B %Y"))) +
  theme_light()
plot4
ggplotly(plot4)
```

Row
---

### **Significant factors:** 1. Total cases (`r paste0("Rate ratio: ", round(model2_rr[2, "estimate"],2), " (95% CI: ", round(model2_rr[2, "conf.low"],2), ", ", round(model2_rr[2, "conf.high"],2), ")")` per increase in case), 2. Days since movement control order (`r paste0("Rate ratio: ", round(model2_rr[3, "estimate"],2), " (95% CI: ", round(model2_rr[3, "conf.low"],2), ", ", round(model2_rr[3, "conf.high"],2), ")")` per day) based on a quasipoisson regression model. However, because of a small sample size for deaths data, the estimated deaths are likely to be inaccurate. Number of cases in ICU and repiratory support are likely to be better predictors, but we do not have complete data from MOH. {.value-box}
```{r}
valueBox(
  value = "",
)
```

<!-- Statistics by State -->
<!-- =================== -->

Data and Our Team
=================

Column
------

###

**The data are sourced from:**

- Ourworldindata: https://covid.ourworldindata.org/data/ecdc/full_data.csv (up to 21/3/2020)
- Ministry of Health of Malaysia press statement: https://kpkesihatan.com/, http://www.moh.gov.my/index.php/pages/view/2019-ncov-wuhan-kenyataan-akhbar, https://www.facebook.com/kkmcprc/
- Our edited data can be accessed from https://data.world/wnarifin/covid-19-my/
- Last updated on `r Sys.Date()`.

**Epidemiology Modelling Team Members, School of Medical Sciences, Universiti Sains Malaysia (USM):**

Department of Community Medicine:

- Assoc. Prof. Dr. Kamarul Imran Musa (Dr. KIM)
- Dr. Mohd Azmi B. Suliman
- Dr. Mohamad Zarudin B Mat Said
- Dr. Wira Alfatah B Ab Ayah @ Ab Aziz
- Dr. Che Muhammad Nur Hidayat B Che Nawi
- Dr. Afiqah Syamimi Bt Masrani
- Mr. Tengku Muhammad Hanis B Tengku Mokhtar

Biostatistics and Research Methodology Unit:

- [Dr. Wan Nor Arifin](https://wnarifin.github.io/)

**Disclaimer: We and USM are not responsible for any damage or inconvenience caused directly or indirectly by the use of this dashboard.**

We built this dashboard using

- RStudio
- Packages:

  - flexdashboard
  - ggplot2
  - plotly
  - broom
  - data.world
