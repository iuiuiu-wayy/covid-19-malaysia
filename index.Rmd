---
title: "Covid-19 in Malaysia Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(plotly)
library(broom)

covid_my = read.csv("https://wnarifin.github.io/misc/covid-19/covid-19_my.csv")
covid_my$date = as.Date(covid_my$date)

sel_location = "Malaysia"
sel_date = Sys.Date()

# tabligh event
covid_my$event = 0
covid_my[covid_my$date >= "2020-02-28", "event"] = 1
covid_my$days_event = cumsum(covid_my$event)
# movement control order, MCO
covid_my$mco = 0
covid_my[covid_my$date >= "2020-03-18", "mco"] = 1
covid_my$days_mco = cumsum(covid_my$mco)

days_event_now = max(covid_my$days_event)
days_mco_now = max(covid_my$days_mco)
```

New Cases
========

```{r}
preg1 = glm(new_cases ~ days_event + days_mco, family = quasipoisson, data = covid_my)
covid_my$new_cases_predicted = round(predict(preg1, type = "response"), 0)
```

Column {data-width=60%}
-----------------------------------------------------------------------

### `r paste("Number of new cases (and predicted for", sel_location, "by", format(sel_date, "%d %B %Y"))`

```{r}
plot1 = ggplot(covid_my) +
  geom_col(aes(x = date, y = new_cases), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = new_cases_predicted), color = "blue", alpha = 0.7) +
  labs(x = "Date", y = "New Cases", title = paste("Number of New Cases for", sel_location, "by", format(sel_date, "%d %B %Y")),
       subtitle = paste("Total Number of Cases =", sum(covid_my$new_cases))) +
  theme_light()
plot1
ggplotly(plot1)
```

Column {data-width=40%}
-----------------------------------------------------------------------

```{r}
preg1_rr = tidy(preg1, conf.int = T, exponentiate = T)
```

**Legend:**

Number of new cases in <b style="color:red">RED</b> bars.

Predicted number of new cases in <b style="color:blue">BLUE</b> line.

**Total number of cases** = `r sum(covid_my$new_cases)`.

**Rate ratio:**

Days since event (Tabligh gathering) = `r paste0(round(preg1_rr[2, "estimate"],2), " (95% CI: ", round(preg1_rr[2, "conf.low"],2), ", ", round(preg1_rr[2, "conf.high"],2), ")")` per day.

Days since movement control order = `r paste0(round(preg1_rr[3, "estimate"],2), " (95% CI: ", round(preg1_rr[3, "conf.low"],2), ", ", round(preg1_rr[3, "conf.high"],2), ")")` per day.

**Predicted number of cases by...**

Tomorrow = `r round(predict(preg1, data.frame(days_event = days_event_now + 1, days_mco = days_mco_now + 1), type = "response"), 0)` cases.

3 days = `r round(predict(preg1, data.frame(days_event = days_event_now + 3, days_mco = days_mco_now + 3), type = "response"), 0)` cases.

7 days = `r round(predict(preg1, data.frame(days_event = days_event_now + 7, days_mco = days_mco_now + 7), type = "response"), 0)` cases.


Deaths
======

```{r}
preg2 = glm(new_deaths ~ days_event, family = quasipoisson, data = covid_my)
covid_my$new_deaths_pred = round(predict(preg2, type = "response"), 0)
```

Column {data-width=60%}
-----------------------------------------------------------------------

### `r paste("Number of deaths (and predicted) for", sel_location, "by", format(sel_date, "%d %B %Y"))`

```{r}
plot2 = ggplot(covid_my) +
  geom_col(aes(x = date, y = new_deaths), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = new_deaths_pred), color = "blue", alpha = 0.7) +
  labs(x = "Date", y = "Deaths", title = paste("Total Number of Deaths =", sum(covid_my$new_deaths))) +
  theme_light()
plot2
ggplotly(plot2)
```

Column {data-width=40%}
-----------------------------------------------------------------------

```{r}
preg2_rr = tidy(preg2, conf.int = T, exponentiate = T)
```

**Legend:**

Number of new deaths in <b style="color:red">RED</b> bars.

Predicted number of new deaths in <b style="color:blue">BLUE</b> line.

**Total number of deaths** = `r sum(covid_my$new_deaths)`.

**Rate ratio:**

Days since event (Tabligh gathering) = `r paste0(round(preg2_rr[2, "estimate"],2), " (95% CI: ", round(preg2_rr[2, "conf.low"],2), ", ", round(preg2_rr[2, "conf.high"],2), ")")` per day.

**Predicted number of cases by...**

Tomorrow = `r round(predict(preg2, data.frame(days_event = days_event_now + 1, days_mco = days_mco_now + 1), type = "response"), 0)` cases.

3 days = `r round(predict(preg2, data.frame(days_event = days_event_now + 3, days_mco = days_mco_now + 3), type = "response"), 0)` cases.

7 days = `r round(predict(preg2, data.frame(days_event = days_event_now + 7, days_mco = days_mco_now + 7), type = "response"), 0)` cases.

Disclaimer
==========

Column {data-width=60%}
------

### Data and Our Team

Data:

- Data is sourced from https://covid.ourworldindata.org/data/ecdc/full_data.csv (up to 21/3/2020) and Ministry of Health of Malaysia.
- The last update was on `r Sys.Date()`.
- Our edited data can be accessed from https://data.world/wnarifin/covid-19-my/

**Epidemiology Modelling Team Members consists of:**

- Assoc Prof Kamarul Imran Musa (KIM)
- Dr Mohd Azmi B. Suliman
- Dr Mohamad Zarudin B Mat Said
- Dr Wira Alfatah B Ab Ayah @ Ab Aziz
- Dr Che Muhammad Nur Hidayat B Che Nawi
- Dr Afiqah Syamimi Bt Masrani
- Sdra Tengku Muhammad Hanis B Tengku Mokhtar
- Dr. Wan Nor Arifin*

Department of Community Medicine & Biostatistics and Research Methodology Unit*,
School of Medical Sciences,
Universiti Sains Malaysia (USM).

**Disclaimer: We and the USM are not responsible for any damage or inconvenience caused directly or indirectly by the use of this dashboard**

We built this dashboard using

- RStudio IDE
- Packages:
  - flexdashboard
  - ggplot2
  - plotly
  - broom
